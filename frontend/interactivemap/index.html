<!DOCTYPE html>
<html>
  <head>
    <title>Pathwise</title>
    <link rel="stylesheet" type="text/css" href="map.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script
      src="https://cdn.socket.io/4.8.0/socket.io.min.js"
      integrity="sha384-OoIbkvzsFFQAG88r+IqMAjyOtYDPGO0cqK5HF5Uosdy/zUEGySeAzytENMDynREd"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC7ftdf2Kqclh1iBAQpKjmOMqfUrGQAN2Y&libraries=places&callback=initMap"
      async
      defer
    ></script>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
        width: 100%;
      }
      #menuBtn {
        cursor: pointer;
      }
    </style>
    <script>
      let map;
      let marker;
      let geocoder;
      let savedPlaceId = ""; // Variable to store the place ID

      const URL = "localhost:3000";
      const localTransitData = {};
      const searchqueries = {};
      var zcounter = 0;
      var routes = {};

      function initMap() {
        console.log("Initializing map...");
        const center = { lat: 43.7735, lng: -79.5019 };

        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 13,
          center: center,
          disableDefaultUI: false,
          draggable: true,
          streetViewControl: false,
          mapTypeControl: true,
          zoomControl: true,
          scrollwheel: true,
          gestureHandling: "greedy",
        });

        console.log("Map initialized.");
        geocoder = new google.maps.Geocoder();

        map.addListener("click", function (event) {
          placeMarker(event.latLng);
          getPlaceId(event.latLng);
        });

        initializeRoutes();
      }

      function initializeRoutes() {
        // Draw a route when the document is loaded with a sample route ID
        $.getJSON(`http://${URL}/transitlabels/`, {}, async function (data) {
          for (var i = 0; i < data.labels.length; i++) {
            routes[data.labels[i]] = await drawRoute(data.labels[i]);
            var entrydiv = document.createElement("div");
            entrydiv.className = "entry";
            entrydiv.id = data.labels[i];
            entrydiv.style.display = "none";

            var checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = "checkbox" + i;
            checkbox.id = "checkbox" + i;
            checkbox.setAttribute("onchange", "handleRouteToggle('checkbox" + i +"', '" + data.labels[i] + "');");
            
            var checkboxlabel = document.createElement("label");
            checkboxlabel.for = "checkbox" + i;
            checkboxlabel.textContent = localTransitData[data.labels[i]]["routelabel"] + " (" + data.labels[i] + ")";
            searchqueries[localTransitData[data.labels[i]]["routelabel"] + " (" + data.labels[i] + ")"] = data.labels[i];
            entrydiv.append(checkbox, checkboxlabel);
            document.getElementById("searchresults").append(entrydiv);
          }
        });
      }

      function handleRouteToggle(check, route_id) {
        console.log("Checked!");
        if (document.getElementById(check).checked) {
          addLine(routes[route_id]);
        } else {
          removeLine(routes[route_id]);
        }
      }

      function onSearch() {
        var query = document.getElementById("search_bar").value;
        var queries = Object.keys(searchqueries);
        for (var i = 0; i < queries.length; i++) {
          if (queries[i].toLowerCase().includes(query.toLowerCase())) {
            document.getElementById(searchqueries[queries[i]]).style.display = "block";
          }
          else {
            document.getElementById(searchqueries[queries[i]]).style.display = "none";
          }
        }
      }

      function addLine(polylines) {
        for (var i = 0; i < polylines.length; i++) {
          polylines[i].setMap(map);
        }
      }

      function removeLine(polylines) {
        for (var i = 0; i < polylines.length; i++) {
          polylines[i].setMap(null);
        }
      }

      function placeMarker(location) {
        if (marker) {
          marker.setPosition(location);
        } else {
          marker = new google.maps.Marker({
            position: location,
            map: map,
          });
        }
      }

      function getPlaceId(location) {
        geocoder.geocode({ location: location }, function (results, status) {
          if (status === "OK") {
            if (results[0]) {
              savedPlaceId = results[0].place_id;
              console.log("Place ID:", savedPlaceId); // You can remove this or replace it with further processing logic
            } else {
              console.log("No results found");
            }
          } else {
            console.log("Geocoder failed due to:", status);
          }
        });
      }

      async function drawRoute(route_id) {
        return new Promise((resolve, reject) => {
          $.getJSON(
            `http://${URL}/transit/`,
            { route_id: route_id },
            function (dataO) {
              localTransitData[route_id] = dataO;
              $.getJSON(
                `http://${URL}/transitlocations/`,
                { shapeids: dataO.shapeids },
                (data) => {
                  var full_shape = [];
                  for (var i = 0; i < data.locations.length; i++) {
                    var currPath = [];
                    for (var j = 0; j < data.locations[i].length; j++) {
                      var currLoc = {
                        lat: parseFloat(data.locations[i][j].latitude),
                        lng: parseFloat(data.locations[i][j].longitude),
                      };
                      currPath.push(currLoc);
                    }
                    var routePolyline = new google.maps.Polyline({
                      path: currPath,
                      geodesic: true,
                      strokeColor: dataO.color,
                      strokeOpacity: 1.0,
                      strokeWeight: 4,
                    });
                    routePolyline.setMap(null);
                    full_shape.push(routePolyline);
                  }
                  console.log(full_shape);
                  for (var i = 0; i < full_shape.length; i++) {
                    google.maps.event.addListener(
                      full_shape[i],
                      "click",
                      function (h, obj = full_shape) {
                        var currZ = ++zcounter;
                        for (var j = 0; j < full_shape.length; j++) {
                          full_shape[j].setOptions({ zIndex: currZ });
                        }
                        console.log("AA");
                      }
                    );
                  }
                  resolve(full_shape);
                }
              );
            }
          );
        });
      }
    </script>
  </head>
  <body>
    <div class="header">
      <svg
        onclick="openSidebar()"
        id="menuBtn"
        xmlns="http://www.w3.org/2000/svg"
        height="30"
        viewBox="0 -960 960 960"
        width="30"
        fill="white"
      >
        <path
          d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"
        />
      </svg>
      <h1>BramWays</h1>
      <button>Login/SignUp</button>
    </div>
    <div id="sidebar">
      <ul>
        <li><a href="#">Home</a></li>
        <li><a href="#">Map</a></li>
        <li><a href="#">Accounts</a></li>
        <li><a href="#">Promo</a></li>
      </ul>
    </div>
    <div id="map"></div>
    <div id="search_bar_div">
      <div id="searchresults"></div>
      <input type="text" id="search_bar" oninput="onSearch();" placeholder="Search Bar" />
    </div>
    <input type="text" class="search_bar" placeholder="Search Bar" />
    <div id="checktest"></div>
    <script>
      function openSidebar() {
        document.getElementById("sidebar").style.display = "flex";
        document
          .getElementById("menuBtn")
          .setAttribute("onclick", "closeSidebar()");
      }
      // when you click the X icon, this function closes the sidebar
      function closeSidebar() {
        document.getElementById("sidebar").style.display = "none";
        document
          .getElementById("menuBtn")
          .setAttribute("onclick", "openSidebar()");
      }
    </script>
  </body>
</html>
