<!DOCTYPE html>
<html>
<head>
    <title>Pathwise</title>
    <link rel="stylesheet" type="text/css" href="main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.socket.io/4.8.0/socket.io.min.js" integrity="sha384-OoIbkvzsFFQAG88r+IqMAjyOtYDPGO0cqK5HF5Uosdy/zUEGySeAzytENMDynREd" crossorigin="anonymous"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC7ftdf2Kqclh1iBAQpKjmOMqfUrGQAN2Y&libraries=places&callback=initMap" async defer></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
    </style>
    <script>
        let map;
        let marker;
        let geocoder;
        let savedPlaceId = ''; // Variable to store the place ID

        function initMap() {
            console.log('Initializing map...');
            const center = { lat: 43.7735, lng: -79.5019 };

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: center,
                disableDefaultUI: false,
                draggable: true,
                streetViewControl: false,
                mapTypeControl: true,
                zoomControl: true,
                scrollwheel: true,
                gestureHandling: 'greedy'
            });

            console.log('Map initialized.');
            geocoder = new google.maps.Geocoder();

            map.addListener('click', function(event) {
                console.log('Map clicked at:', event.latLng);
                placeMarker(event.latLng);
                getPlaceId(event.latLng);
            });

            // Draw a route when the document is loaded with a sample route ID
            drawRoute('205-349');
        }

        function placeMarker(location) {
            if (marker) {
                marker.setPosition(location);
            } else {
                marker = new google.maps.Marker({
                    position: location,
                    map: map
                });
            }
        }

        function getPlaceId(location) {
            geocoder.geocode({ location: location }, function(results, status) {
                if (status === 'OK') {
                    if (results[0]) {
                        savedPlaceId = results[0].place_id;
                        console.log('Place ID:', savedPlaceId); // You can remove this or replace it with further processing logic
                    } else {
                        console.log('No results found');
                    }
                } else {
                    console.log('Geocoder failed due to:', status);
                }
            });
        }

        function drawRoute(route_id) {
            console.log('Fetching route for ID:', route_id);
            $.ajax({
                url: `http://localhost:3000/transitlocations/?route_id=${route_id}`,
                type: 'GET',
                success: function(response) {
                    console.log('Response received:', response);
                    if (response.longLat && response.longLat.length > 0) {
                        const routeCoordinates = response.longLat.map(coord => {
                            return { lat: coord[0], lng: coord[1] };
                        });

                        console.log('Route coordinates:', routeCoordinates);

                        const routePolyline = new google.maps.Polyline({
                            path: routeCoordinates,
                            geodesic: true,
                            strokeColor: '#0000FF',
                            strokeOpacity: 1.0,
                            strokeWeight: 4
                        });
                        routePolyline.setMap(map);
                        console.log('Route polyline added to the map.');
                    } else {
                        console.error('No latitude and longitude data available for this route.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX request error:', error);
                }
            });
        }
    </script>
</head>
<body>
    <div id="map"></div>
</body>
</html>
